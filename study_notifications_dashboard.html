<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Notifications Dashboard</title>
    <style>
        :root {
            --bg-color: #f8fafc;
            --container-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --card-hover: #f1f5f9;
        }

        [data-theme="dark"] {
            --bg-color: #1a202c;
            --container-bg: #2d3748;
            --text-color: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow: rgba(0, 0, 0, 0.3);
            --card-hover: #374151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        select, input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .export-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .export-btn.json {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        .export-btn.json:hover {
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            align-self: end;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .study-card {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px var(--shadow);
            border-left: 5px solid #667eea;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            color: var(--text-color);
        }

        .study-card.selected {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }

        .study-card.no-dta-file {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .study-card.has-dta-file {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }

        .study-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow);
            background: var(--card-hover);
        }

        .study-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .study-code {
            font-size: 1.1em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .study-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-progress { background: #FFF3CD; color: #856404; }
        .status-transferred { background: #D4EDDA; color: #155724; }
        .status-ready { background: #CCE5FF; color: #004085; }
        .status-dta { background: #F8D7DA; color: #721C24; }
        .status-reactivate { background: #E2E3E5; color: #383D41; }

        .study-description {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .study-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .notification-preview {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 25px var(--shadow);
            margin-top: 30px;
            display: none;
        }

        .notification-preview.show {
            display: block;
        }

        .notification-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            border-radius: 10px;
        }

        .notification-content {
            display: grid;
            gap: 25px;
        }

        .notification-section {
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .notification-section h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .priority-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high { background: #FFE6E6; color: #D63384; }
        .priority-medium { background: #FFF3CD; color: #856404; }
        .priority-standard { background: #D4EDDA; color: #155724; }

        .action-required {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: #dc3545;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .dta-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            border: 1px solid #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .dta-link:hover {
            background: #667eea;
            color: white;
            text-decoration: none;
        }

        .dta-link.missing {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .dta-link.missing:hover {
            background: #e74c3c;
            color: white;
        }

        .file-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .file-status-indicator.available {
            background: #27ae60;
        }

        .file-status-indicator.missing {
            background: #e74c3c;
        }

        .file-status-indicator.placeholder {
            background: #f39c12;
        }

        .dta-metadata-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dta-template, .dta-recipient, .dta-status {
            font-size: 0.9em;
            font-weight: 600;
            margin-right: 20px;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .studies-grid {
                grid-template-columns: 1fr;
            }
            
            .study-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>📊 Study Notifications Dashboard</h1>
            <p>Generate customized DTA notifications for research studies</p>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="totalStudies">0</div>
                <div class="stat-label">Total Studies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rp1Count">0</div>
                <div class="stat-label">RP1 Studies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rp2Count">0</div>
                <div class="stat-label">RP2 Studies</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="selectedCount">0</div>
                <div class="stat-label">Selected</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="dtaCoverage">0%</div>
                <div class="stat-label">DTA File Coverage</div>
            </div>
        </div>

        <div class="controls">
            <div class="filters">
                <select id="countryFilter" aria-label="Filter by country">
                    <option value="">All Countries</option>
                </select>
                <select id="statusFilter" aria-label="Filter by status">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="follow_up">Follow Up</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="typeFilter" aria-label="Filter by study type">
                    <option value="">All Types</option>
                    <option value="RP1">RP1</option>
                    <option value="RP2">RP2</option>
                </select>
                <select id="dtaFileFilter" aria-label="Filter by DTA file availability">
                    <option value="">All Studies</option>
                    <option value="has_dta">With DTA Files</option>
                    <option value="no_dta">Without DTA Files</option>
                    <option value="spreadsheet_only">Spreadsheet Only</option>
                </select>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search studies..." aria-label="Search studies" />
                <button id="clearSearch">Clear</button>
            </div>
            <div class="export-buttons">
                <button class="export-btn json" onclick="exportJson()">JSON</button>
                <button class="export-btn csv" onclick="exportCsv()">CSV</button>
            </div>
            <button class="generate-btn" onclick="generateNotification()">
                🔔 Generate Notification
            </button>
        </div>

        <div class="studies-grid" id="studiesGrid">
            <!-- Studies will be populated here -->
        </div>

        <div class="notification-preview" id="notificationPreview">
            <div class="notification-header">
                <h2>📧 DTA Cloud Migration Notification</h2>
                <p>Ready for distribution to study contacts</p>
            </div>
            <div class="notification-content" id="notificationContent">
                <!-- Notification content will be generated here -->
            </div>
            <button class="copy-btn" onclick="copyNotification()">
                📋 Copy Notification Text
            </button>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">🌙 Toggle Dark Mode</button>
    </div>

    <script>
        // DTA File Mappings - linking study codes to their respective files on GitHub
        const dtaFileMappings = {
            "BWA072": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/2410710-01.DTA_HEAT001_v2.0_WHC_BWA072_FE.pdf",
            "CAP088": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/DTA_2402820-01.CM_CAP088_SAHAPS_CAPRISA_WITS_FE%2015%20Apr%202024.pdf",
            "DID261": "[filename_TBD]",
            "EAT001": "[multiple_files]",
            "ETH501": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/DTA_WHC_ETH501_signed.pdf",
            "ETH553": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/24033800-01.CM%20-%20ETH553_FE.pdf",
            "ETH563": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_drafts_WHC/DTA_HEAT001_V2.0_WHC_ETH563.docx",
            "ETH570": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/ETH570_DTA_Maternal%20Alcohol%20consumption_Dr%20Alemu_signed.pdf",
            "GHA020": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_final_UCT/FE%20DTA-2025-0264%20UCD%20-%20Cape%20Town%20Univ.%20DTA_HEAT001_v2.0_UCT_38344_GHA020.pdf",
            "KEN086": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_UCT35447_KEN086_DUA_Standard_Template_v1.5%20(1)%20LvA%20Edited%2016.03.2023_signature.pdf",
            "KEN531": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/KEN531_6839_6716_124%20DTA_Template_HEAT001_v2.0_WHC_UABComments021925%20_FE.pdf",
            "KEN539": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/UT35438_DTA%20PAI-HEAT_KEN539_MomCare%20study_For%20Signature%20-%20signed.pdf",
            "MUL090": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/HDID26143KR24%20FE%20WHC_DTAv2_MUL090_2504370-01.CM.pdf",
            "MUL159": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/230502_MUL159_IMPAACT%20SDUA%20Signed%20WHC.pdf",
            "MUL352": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_drafts_WHC/DTA_Template_HEAT001_v2.0_WHC_MUL352.docx",
            "MWI021": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_DTA_HEAT001_UCT35523_MWI021_MWI026_2023-05-16.pdf",
            "MWI026": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_DTA_HEAT001_UCT35523_MWI021_MWI026_2023-05-16.pdf",
            "MWI049": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_DTA_HEAT001_UCT35523_MWI049_2023-05-15.pdf",
            "MWI064": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/DTA_HEAT001_UCT35664-MWI064-MWI534_20230329_v1_Final.pdf",
            "MWI088": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_UCT35372_CDC_DUA_MWI088_15.02.2023-1AK%20CLEAN_23.03.2023_AK.pdf",
            "MWI094": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/MWI094%20PRIME_DTA_NHI-Individual%20participation%20Agreement_201223.pdf",
            "MWI097": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/MWI097_WHC_PURE%20Study%20DTA%20Signed.pdf",
            "MWI152": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_UCT35524_DTA_HEAT001_UCT35524-MWI152_10.05.2024.docx.pdf",
            "MWI198": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/23071200_MWI198%20and%20MWI524_DTA_POISE%20and%20PEPI%20with%20JHU_signed.pdf",
            "MWI524": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/23071200_MWI198%20and%20MWI524_DTA_POISE%20and%20PEPI%20with%20JHU_signed.pdf",
            "MWI532": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/MWI532_Confirmation%20of%20Data%20Received%20APPLe_Prof%20Nynke%20van%20den%20Broek.msg",
            "NGA547": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_drafts_WHC/DTA_NGA547_WHC%20TEMPLATE-UI%20and%20WITTS.docx",
            "NGA548": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/9328_1551_DTA_HEAT001LEGAL%20signature_AGREEMENT_NGA548%2028%206%2024%20EvW.pdf",
            "SLE054": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/FE_DUA_with_WHC_SLE054%20final.pdf",
            "TZA079": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/FE_01212025_Agreement_for_DUA24-0995_Wits_Duggan_TZA079_TZA080.pdf",
            "TZA080": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/FE_01212025_Agreement_for_DUA24-0995_Wits_Duggan_TZA079_TZA080.pdf",
            "TZA380": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/UCT37159_UCT%20Signed_DTA_NIMR_TZA380.pdf",
            "TZA556": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_DATA%20TRANSFER%20AGREEMENT_05042023_TZA556.pdf",
            "ZAF014": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_DTA_HEAT001_UCT35526-ZAF014_20230329_v1_UP%20Signed.pdf",
            "ZAF055": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/DTA_HEAT001_UCT35525-ZAF055_20230328_FE.pdf",
            "ZAF106": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/23101700-01.DSA-VIDA%20studies_INCL%20ZAF106_WHC1_signed.pdf",
            "ZAF124": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/ZAF124_Stellenbosch_WHC_Safe%20Passage%20DTA%20signed.pdf",
            "ZAF145": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_drafts_WHC/20250430%20S009731%20DTA_Template_HEAT001_v2.0_WHC_ZAF145.docx",
            "ZAF162": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/UCT39528_UCT%20studies_ZAF162_ZAF504_ZAF517_ZAF544_FE.pdf",
            "ZAF163": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/DTA_2402820-01.CM_CAP088_SAHAPS_CAPRISA_WITS_FE%2015%20Apr%202024_ZAF163.pdf",
            "ZAF192": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_12781%20DTA_HEAT001_UCT35366-ZAF192_20230328_v1.pdf",
            "ZAF357": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_DTA_HEAT001_20230328_UCT35599_ZAF357_ZAF358.pdf",
            "ZAF358": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_through_UCT/FE_DTA_HEAT001_20230328_UCT35599_ZAF357_ZAF358.pdf",
            "ZAF504": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/UCT39528_UCT%20studies_ZAF162_ZAF504_ZAF517_ZAF544_FE.pdf",
            "ZAF517": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/UCT39528_UCT%20studies_ZAF162_ZAF504_ZAF517_ZAF544_FE.pdf",
            "ZAF544": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_fully%20executed_WHC/UCT39528_UCT%20studies_ZAF162_ZAF504_ZAF517_ZAF544_FE.pdf",
            "ZAF600": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/DTAs_though_WHC/2402810-01.DTA_ZAF600.pdf",
            "ZMB137": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_final_UCT/FE_UCT39547_25-0842%20UNC_UCT_ZMB137%20ZAPPS.pdf",
            "ZMB173": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_final_UCT/ZMB173_UCT39547_25-0842+UNC_UCT_FE.pdf",
            "ZMB530": "https://logic06183.github.io/Notifications/Executed%20DTA's-selected/New%20DTAs_final_UCT/ZMB530_Hamer_BU_UNIVERSITY%20OF%20CAPE%20TOWN_DTA_Template_HEAT001_FE.pdf",
            
            // RP2 Studies from Executed DTAs folder
            "RP2_EZintsha": "https://logic06183.github.io/Notifications/Executed%20DTAs/2309620-01.DSA_Ezintsha%20DTA.pdf",
            "RP2_WHC": "https://logic06183.github.io/Notifications/Executed%20DTAs/2309760-01.DTA_WHC%20signed.pdf",
            "RP2_VIDA": "https://logic06183.github.io/Notifications/Executed%20DTAs/23101700-01.DSA-signed%205%20VIDA%20studies.pdf",
            "RP2_MEAKI": "https://logic06183.github.io/Notifications/Executed%20DTAs/2401510-01.DTA_MEAKI_MFC.pdf",
            "RP2_MIRA": "https://logic06183.github.io/Notifications/Executed%20DTAs/24061620-01.CM_MIRA.pdf",
            "RP2_CHARISMA": "https://logic06183.github.io/Notifications/Executed%20DTAs/2406170-01.CM_DSA%20_CHARISMAsigned.pdf",
            "RP2_BMDCART": "https://logic06183.github.io/Notifications/Executed%20DTAs/24071090-01.CM_BMDCART_MFC.pdf",
            "RP2_MLTF": "https://logic06183.github.io/Notifications/Executed%20DTAs/9360_8408_DSA_MLTF.pdf"
        };

        // Notification tracking - track which studies have had notifications sent
        let notificationsSent = JSON.parse(localStorage.getItem('notificationsSent') || '{}');

        // Function to derive DTA metadata from folder path
        function getDtaMetadataFromPath(filePath) {
            if (!filePath) return { template: 'N/A', recipient: 'N/A', status: 'N/A' };
            
            // Extract folder name from path
            const pathParts = filePath.split('/');
            const folderName = pathParts[pathParts.length - 2]; // Get the folder name
            
            let template, recipient, status;
            
            if (folderName.includes('DTAs_though_WHC')) {
                template = 'old';
                recipient = 'WHC';
                status = 'executed';
            } else if (folderName.includes('DTAs_through_UCT')) {
                template = 'old';
                recipient = 'UCT';
                status = 'executed';
            } else if (folderName.includes('New DTAs_drafts_WHC')) {
                template = 'new';
                recipient = 'WHC';
                status = 'draft';
            } else if (folderName.includes('New DTAs_final_UCT')) {
                template = 'new';
                recipient = 'UCT';
                status = 'final';
            } else if (folderName.includes('New DTAs_fully executed_WHC')) {
                template = 'new';
                recipient = 'WHC';
                status = 'fully_executed';
            } else {
                template = 'N/A';
                recipient = 'N/A';
                status = 'N/A';
            }
            
            return { template, recipient, status };
        }

        // Function to open DTA file directly
        function openDtaFile(studyCode) {
            const fileUrl = dtaFileMappings[studyCode];
            if (fileUrl && !fileUrl.includes('[filename_TBD]') && !fileUrl.includes('[multiple_files]')) {
                window.open(fileUrl, '_blank');
            } else {
                alert(`DTA file not available for study ${studyCode}`);
            }
        }

        // Combined study data from RP1 and RP2 files
        const studyData = {
            rp1: [
                // Botswana
                {
                    code: "BWA072",
                    title: "Study to Improve Survival Among HIV-Exposed Infants in Botswana - The Mpepu Study",
                    country: "Botswana",
                    status: "Transfer of Data in progress (UCT)",
                    type: "RP1",
                    sample_size: "3334",
                    priority: "High",
                    contact: "gajibola@bhp.org.bw"
                },
                // Ethiopia
                {
                    code: "ETH553",
                    title: "Adverse maternal outcomes of adolescent pregnancy in Northwest Ethiopia: A prospective cohort study",
                    country: "Ethiopia",
                    status: "Transfer of Data in progress (UCT)",
                    type: "RP1",
                    priority: "Standard",
                    contact: "gechm2005@gmail.com"
                },
                {
                    code: "ETH563",
                    title: "Incidence of preterm premature rupture of membranes and inter-pregnancy interval studies",
                    country: "Ethiopia",
                    status: "Data transferred to UCT",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ETH570",
                    title: "Effects of maternal alcohol consumption during pregnancy on adverse fetal outcomes",
                    country: "Ethiopia",
                    status: "Recheck eligibility after looking at the data (UCT)",
                    type: "RP1",
                    priority: "Medium"
                },
                {
                    code: "ETH501",
                    title: "Maternal and Newborn Health in Ethiopia Partnership project",
                    country: "Ethiopia",
                    status: "DTA completed through Wits",
                    type: "RP1",
                    priority: "Standard",
                    contact: "yirgurob@gmail.com"
                },
                // Ghana
                {
                    code: "GHA020",
                    title: "Efficacy of Lipid-Based Nutrient Supplements (LNS) for Pregnant and Lactating Women - iLiNS-DYAD",
                    country: "Ghana",
                    status: "Data transferred to UCT",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "GHA075",
                    title: "Enhanced AnteNatal Care service package for Malaria and Anaemia in Pregnancy EANC-MAP",
                    country: "Ghana",
                    status: "Entering into DTA (UCT)",
                    type: "RP1",
                    priority: "Medium"
                },
                // Kenya
                {
                    code: "KEN086",
                    title: "STOPMIP Kenya",
                    country: "Kenya",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "KEN539",
                    title: "MomCare Project",
                    country: "Kenya",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "KEN531",
                    title: "Testing Strategies for Couple Engagement in PMTCT and Family Health (Jamii Bora)",
                    country: "Kenya",
                    status: "Entering into DTA (Wits)",
                    type: "RP1",
                    priority: "High"
                },
                {
                    code: "KEN030",
                    title: "PRIMA - PrEP Implementation for Mothers in Antenatal Care",
                    country: "Kenya",
                    status: "Entering into DTA (Wits)",
                    type: "RP1",
                    priority: "High",
                    contact: "gjohn@uw.edu"
                },
                {
                    code: "KEN136",
                    title: "Mama Salama",
                    country: "Kenya",
                    status: "Entering into DTA (Wits)",
                    type: "RP1",
                    priority: "Medium",
                    contact: "gjohn@uw.edu"
                },
                // Malawi
                {
                    code: "MWI152",
                    title: "Pregnancy intentions",
                    country: "Malawi",
                    status: "Data transferred to UCT",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI064",
                    title: "PASTAL",
                    country: "Malawi",
                    status: "Recheck eligibility after looking at the data (UCT)",
                    type: "RP1",
                    priority: "Medium"
                },
                {
                    code: "MWI532",
                    title: "APPLe",
                    country: "Malawi",
                    status: "Recheck eligibility after looking at the data (UCT)",
                    type: "RP1",
                    priority: "Medium"
                },
                {
                    code: "MWI534",
                    title: "ANC/FRS",
                    country: "Malawi",
                    status: "Recheck eligibility after looking at the data (UCT)",
                    type: "RP1",
                    priority: "Medium"
                },
                {
                    code: "MWI021",
                    title: "iLiNS-DYAD M",
                    country: "Malawi",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI086",
                    title: "STOPMIP Malawi",
                    country: "Malawi",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI026",
                    title: "LAIS",
                    country: "Malawi",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI198",
                    title: "PEPI",
                    country: "Malawi",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI097",
                    title: "The PURE Study",
                    country: "Malawi",
                    status: "problem with geolocation",
                    type: "RP1",
                    priority: "High"
                },
                {
                    code: "MWI088",
                    title: "BAN",
                    country: "Malawi",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI524",
                    title: "POISE",
                    country: "Malawi",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI094",
                    title: "PRIME",
                    country: "Malawi",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MWI049",
                    title: "Interventions for Moderate Malnutrition in Pregnancy (Mamachiponde)",
                    country: "Malawi",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                // Multicountry
                {
                    code: "MUL159",
                    title: "Promoting Maternal and Infant Survival Everywhere (PROMISE) Protocol. PROMISE 1077BF",
                    country: "Multicountry",
                    status: "health check",
                    type: "RP1",
                    priority: "Medium"
                },
                {
                    code: "MUL140",
                    title: "PREGACT",
                    country: "Multicountry",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MUL006",
                    title: "COSMIC",
                    country: "Multicountry",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "MUL090",
                    title: "PROMISE EBF - Safety and Efficacy of Exclusive Breastfeeding Promotion",
                    country: "Multicountry",
                    status: "Linking email sent",
                    type: "RP1",
                    priority: "Standard",
                    contact: "Tanya.Doherty@mrc.ac.za"
                },
                // Nigeria
                {
                    code: "NGA548",
                    title: "Prevalence, seroconversion and mother-to-child transmission of dual and triplex infections",
                    country: "Nigeria",
                    status: "Linking email sent",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "NGA547",
                    title: "Ibadan Pregnancy Cohort Study",
                    country: "Nigeria",
                    status: "Entering into DTA (Wits)",
                    type: "RP1",
                    priority: "Standard",
                    contact: "adeoyeikeola@yahoo.com",
                    sample_size: "1745"
                },
                // Sierra Leone
                {
                    code: "SLE054",
                    title: "Nutritional and Anti-infective Interventions for Malnutrition in Pregnancy (Beleuman Welbodi)",
                    country: "Sierra Leone",
                    status: "Linking email sent",
                    type: "RP1",
                    priority: "Standard",
                    contact: "manarymj@wustl.edu"
                },
                // South Africa
                {
                    code: "ZAF581",
                    title: "CAP088",
                    country: "South Africa",
                    status: "Pre-processing (UCT)",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF155",
                    title: "COHORTS Birth to 20",
                    country: "South Africa",
                    status: "Data transferred to UCT",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF192",
                    title: "Goodstart",
                    country: "South Africa",
                    status: "Processed for mapping (UCT)",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF014",
                    title: "GDM",
                    country: "South Africa",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF358",
                    title: "Low HIV incidence in pregnant and postpartum women receiving community-based prevention",
                    country: "South Africa",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF357",
                    title: "Effectiveness of community-based support for pregnant women living with HIV",
                    country: "South Africa",
                    status: "harmonization coding check",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF124",
                    title: "The Safe Passage Study",
                    country: "South Africa",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF600",
                    title: "Healthy Mother Healthy Baby Programme",
                    country: "South Africa",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF055",
                    title: "PMTCT South African couples",
                    country: "South Africa",
                    status: "Dataset ready for analysis",
                    type: "RP1",
                    priority: "Standard"
                },
                {
                    code: "ZAF145",
                    title: "Philani study",
                    country: "South Africa",
                    status: "Entering into DTA (Wits)",
                    type: "RP1",
                    priority: "Medium",
                    contact: "markt@sun.ac.za"
                },
                {
                    code: "ZAF515",
                    title: "MACE - Mother and Child in the Environment birth cohort",
                    country: "South Africa",
                    status: "Entering into DTA (Wits)",
                    type: "RP1",
                    priority: "Medium",
                    contact: "naidoon@ukzn.ac.za"
                },
                {
                    code: "ZAF007",
                    title: "DCHS - Drakenstein Child Health Study",
                    country: "South Africa",
                    status: "DTA being processed through WITS",
                    type: "RP1",
                    priority: "Standard",
                    contact: "heather.zar@uct.ac.za"
                },
                {
                    code: "ZAF106",
                    title: "MATFLU - Influenza Vaccine Trial in HIV Uninfected Pregnant Women",
                    country: "South Africa",
                    status: "Linking email sent",
                    type: "RP1",
                    priority: "Standard",
                    contact: "catherine.hill@wits-vida.org"
                },
                {
                    code: "ZAF517",
                    title: "PIMS - Prematurity Immunology in HIV-infected Mothers and their infants Study",
                    country: "South Africa",
                    status: "Linking email sent",
                    type: "RP1",
                    priority: "Standard",
                    contact: "landon.myer@uct.ac.za"
                },
                // Tanzania
                {
                    code: "TZA380",
                    title: "Medication exposure during pregnancy: pilot pharmacovigilance system",
                    country: "Tanzania",
                    status: "DTA with Jessica (UCT)",
                    type: "RP1",
                    priority: "Standard"
                },
                // Uganda
                {
                    code: "UGA077",
                    title: "Uganda Peripartum Infection and Mortality UPIM study",
                    country: "Uganda",
                    status: "DTA with Jessica (UCT)",
                    type: "RP1",
                    sample_size: "4231",
                    priority: "High",
                    contact: "jngonzi@must.ac.ug"
                },
                // Zambia
                {
                    code: "ZMB343",
                    title: "Epidemiology of malaria and curable STIs/RTIs among pregnant women",
                    country: "Zambia",
                    status: "DTA with Jessica (UCT)",
                    type: "RP1",
                    priority: "High",
                    sample_size: "1086"
                },
                {
                    code: "ZMB174",
                    title: "Zambia Chlorhexidine Application Trial (ZamCAT)",
                    country: "Zambia",
                    status: "Transfer of Data in progress (UCT)",
                    type: "RP1",
                    priority: "High",
                    sample_size: "39679"
                },
                {
                    code: "ZMB137",
                    title: "ZAPPS - Zambian Preterm Birth Prevention Study",
                    country: "Zambia",
                    status: "Transfer of Data in progress (UCT)",
                    type: "RP1",
                    priority: "High",
                    sample_size: "1450"
                },
                {
                    code: "DID261",
                    title: "DID261 - Research Study",
                    country: "Unknown",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "fully_executed"
                },
                {
                    code: "EAT001",
                    title: "EAT001 - Research Study",
                    country: "Unknown",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "fully_executed"
                },
                {
                    code: "MUL352",
                    title: "MUL352 - Multi-site Study",
                    country: "Multi-country",
                    status: "Draft DTA",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "draft"
                },
                {
                    code: "TZA079",
                    title: "TZA079 - Tanzania Study",
                    country: "Tanzania",
                    status: "DTA Executed",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "fully_executed"
                },
                {
                    code: "TZA080",
                    title: "TZA080 - Tanzania Study",
                    country: "Tanzania",
                    status: "DTA Executed",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "fully_executed"
                },
                {
                    code: "TZA556",
                    title: "TZA556 - Tanzania Study",
                    country: "Tanzania",
                    status: "DTA through UCT",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "UCT",
                    dta_status: "executed"
                },
                {
                    code: "UCT353",
                    title: "UCT353 - UCT Study",
                    country: "South Africa",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "UCT",
                    dta_status: "executed"
                },
                {
                    code: "UCT354",
                    title: "UCT354 - UCT Study",
                    country: "South Africa",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "UCT",
                    dta_status: "executed"
                },
                {
                    code: "UCT355",
                    title: "UCT355 - UCT Study",
                    country: "South Africa",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "UCT",
                    dta_status: "executed"
                },
                {
                    code: "UCT356",
                    title: "UCT356 - UCT Study",
                    country: "South Africa",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "UCT",
                    dta_status: "executed"
                },
                {
                    code: "UCT371",
                    title: "UCT371 - UCT Study",
                    country: "South Africa",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "UCT",
                    dta_status: "executed"
                },
                {
                    code: "UCT381",
                    title: "UCT381 - UCT Study",
                    country: "South Africa",
                    status: "DTA Available",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "UCT",
                    dta_status: "executed"
                },
                {
                    code: "ZAF162",
                    title: "ZAF162 - South Africa Study",
                    country: "South Africa",
                    status: "DTA Executed",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "fully_executed"
                },
                {
                    code: "ZAF163",
                    title: "ZAF163 - South Africa Study",
                    country: "South Africa",
                    status: "DTA though WHC",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "old",
                    main_recipient: "WHC",
                    dta_status: "executed"
                },
                {
                    code: "ZAF504",
                    title: "ZAF504 - South Africa Study",
                    country: "South Africa",
                    status: "DTA Executed",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "fully_executed"
                },
                {
                    code: "ZAF544",
                    title: "ZAF544 - South Africa Study",
                    country: "South Africa",
                    status: "DTA Executed",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "WHC",
                    dta_status: "fully_executed"
                },
                {
                    code: "ZMB173",
                    title: "ZMB173 - Zambia Study",
                    country: "Zambia",
                    status: "Final DTA",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "UCT",
                    dta_status: "final"
                },
                {
                    code: "ZMB530",
                    title: "ZMB530 - Zambia Study",
                    country: "Zambia",
                    status: "Final DTA",
                    type: "RP1",
                    priority: "Medium",
                    sample_size: "TBD",
                    dta_template: "new",
                    main_recipient: "UCT",
                    dta_status: "final"
                }
            ],
            rp2: [
                // All RP2 studies are South Africa based (Johannesburg sites)
                {
                    code: "JHB_WCRBara_36_CAPSTONE2",
                    title: "CAPSTONE2 - Baloxavir marboxil efficacy study",
                    country: "South Africa",
                    status: "declined participation",
                    type: "RP2",
                    priority: "Standard",
                    nct: "NCT02949011",
                    sample_size: "278"
                },
                {
                    code: "JHB_MTN-SCHARP_012_CHARISMA",
                    title: "CHARISMA - Community Health clinic model for Agency in Relationships",
                    country: "South Africa",
                    status: "declined participation",
                    type: "RP2",
                    priority: "Standard",
                    nct: "NCT04092114",
                    sample_size: "407"
                },
                {
                    code: "JHB_NHLS_38_Boston",
                    title: "Boston Hero Group Database Platform",
                    country: "South Africa",
                    status: "Data currently unavailable",
                    type: "RP2",
                    priority: "Standard"
                },
                {
                    code: "JHB_PHRU_46_ENSEMBLE_COV2.S",
                    title: "ENSEMBLE COV2.S - COVID-19 vaccine trial",
                    country: "South Africa",
                    status: "Data currently unavailable",
                    type: "RP2",
                    priority: "Medium",
                    nct: "NCT04505722",
                    sample_size: "44325"
                },
                {
                    code: "JHB_PHRU_48_PHOENIx_MDRTB",
                    title: "PHOENIx - Multi-drug Resistant TB Study",
                    country: "South Africa",
                    status: "Data currently unavailable",
                    type: "RP2",
                    priority: "Standard"
                },
                {
                    code: "JHB_WitsRHI_49_RECOVERY_COVID19",
                    title: "RECOVERY - COVID-19 Treatment Study",
                    country: "South Africa",
                    status: "Data currently unavailable",
                    type: "RP2",
                    priority: "Standard",
                    sample_size: "50000"
                },
                {
                    code: "JHB_WRHI_39_HPTN084",
                    title: "HPTN 084 - HIV Prevention Study",
                    country: "South Africa",
                    status: "Data currently unavailable",
                    type: "RP2",
                    priority: "High",
                    nct: "NCT03164564",
                    sample_size: "382"
                },
                {
                    code: "JHB_WRHI_Soweto_40_HPTN052",
                    title: "HPTN052 - HIV Treatment as Prevention",
                    country: "South Africa",
                    status: "Data currently unavailable",
                    type: "RP2",
                    priority: "Standard"
                },
                {
                    code: "JHB_VIDA_50_PertussisVax_HIV_PregnantWomen",
                    title: "Pertussis vaccination among HIV-infected and HIV-uninfected pregnant women",
                    country: "South Africa",
                    status: "Reactivate",
                    type: "RP2",
                    priority: "High",
                    nct: "NCT05264662",
                    contact: "marta.nunes@wits-vida.org"
                },
                {
                    code: "JHB_WCR_38_SPECTRA",
                    title: "SPECTRA - COVID-19 Prevention Vaccine Study",
                    country: "South Africa",
                    status: "Reactivate",
                    type: "RP2",
                    priority: "Standard",
                    nct: "NCT04672395",
                    sample_size: "31454"
                },
                {
                    code: "JHB_CHRU_23_SOLIDARITY",
                    title: "SOLIDARITY - COVID-19 Clinical Trial",
                    country: "South Africa",
                    status: "Reactivate",
                    type: "RP2",
                    priority: "Standard",
                    contact: "mrassool@witshealth.co.za"
                },
                {
                    code: "JHB_CHRU_30_REMoxTB_ACTGA5349",
                    title: "REMoxTB - Moxifloxacin TB Treatment Study",
                    country: "South Africa",
                    status: "Reactivate",
                    type: "RP2",
                    priority: "Standard",
                    nct: "NCT00864383",
                    sample_size: "1931"
                },
                {
                    code: "JHB_Ezin_43_RCT_COVID_Ribavirin_Nitazoxanide",
                    title: "COVID-19 Ribavirin and Nitazoxanide Treatment Study",
                    country: "South Africa",
                    status: "Reactivate",
                    type: "RP2",
                    priority: "Standard",
                    nct: "NCT04563208",
                    sample_size: "80"
                },
                {
                    code: "JHB_PHRU_35_HVTN705_HPX2008",
                    title: "HVTN 705/HPX2008 - HIV Prevention Vaccine Study",
                    country: "South Africa",
                    status: "Reactivate",
                    type: "RP2",
                    priority: "Standard",
                    nct: "NCT03060629",
                    sample_size: "200"
                },
                {
                    code: "JHB_PHRU_41_CoVPN3008_PF_Soweto",
                    title: "CoVPN3008 - Pfizer COVID-19 Study",
                    country: "South Africa",
                    status: "Reactivate",
                    type: "RP2",
                    priority: "Standard",
                    nct: "NCT05168813"
                }
            ]
        };

        let allStudies = [...studyData.rp1, ...studyData.rp2];
        let selectedStudies = [];
        let filteredStudies = allStudies;

        function setupEventListeners() {
            const countrySelect = document.getElementById('countryFilter');
            const statusSelect = document.getElementById('statusFilter');
            const typeSelect = document.getElementById('typeFilter');
            const dtaFileSelect = document.getElementById('dtaFileFilter');
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearch');

            countrySelect.addEventListener('change', applyFilters);
            statusSelect.addEventListener('change', applyFilters);
            typeSelect.addEventListener('change', applyFilters);
            dtaFileSelect.addEventListener('change', applyFilters);
            searchInput.addEventListener('input', applyFilters);
            
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                applyFilters();
            });
        }

        function toggleNotificationSent(code, isChecked){
            notificationsSent[code]=isChecked;
            localStorage.setItem('notificationsSent', JSON.stringify(notificationsSent));
            applyFilters(); // re-render to update class coloring/stats
        }

        function initializeDashboard() {
            populateFilters();
            updateStats();
            renderStudies();
            setupEventListeners();
        }

        function populateFilters() {
            const countries = [...new Set(allStudies.map(s => s.country))].sort();
            const statuses = [...new Set(allStudies.map(s => s.status))].sort();

            const countrySelect = document.getElementById('countryFilter');
            const statusSelect = document.getElementById('statusFilter');

            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusSelect.appendChild(option);
            });
        }

        function applyFilters() {
            const countryFilter = document.getElementById('countryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const dtaFileFilter = document.getElementById('dtaFileFilter').value;

            filteredStudies = allStudies.filter(study => {
                // Check DTA file status for filtering
                let hasDtaFile = false;
                let isSpreadsheetOnly = false;
                
                if (dtaFileMappings[study.code]) {
                    if (dtaFileMappings[study.code].includes('[filename_TBD]') || dtaFileMappings[study.code].includes('[multiple_files]')) {
                        isSpreadsheetOnly = true;
                    } else {
                        hasDtaFile = true;
                    }
                } else {
                    isSpreadsheetOnly = true;
                }

                return (!countryFilter || study.country === countryFilter) &&
                       (!statusFilter || study.status === statusFilter) &&
                       (!typeFilter || study.type === typeFilter) &&
                       (study.code.toLowerCase().includes(searchQuery) ||
                        study.title.toLowerCase().includes(searchQuery) ||
                        study.country.toLowerCase().includes(searchQuery)) &&
                       (!dtaFileFilter || 
                        (dtaFileFilter === 'has_dta' && hasDtaFile) ||
                        (dtaFileFilter === 'no_dta' && !hasDtaFile) ||
                        (dtaFileFilter === 'spreadsheet_only' && isSpreadsheetOnly));
            });

            // Prioritize studies with DTA files in the results
            filteredStudies.sort((a, b) => {
                const aHasDta = dtaFileMappings[a.code] && !dtaFileMappings[a.code].includes('[filename_TBD]') && !dtaFileMappings[a.code].includes('[multiple_files]');
                const bHasDta = dtaFileMappings[b.code] && !dtaFileMappings[b.code].includes('[filename_TBD]') && !dtaFileMappings[b.code].includes('[multiple_files]');
                
                // Studies with DTA files come first
                if (aHasDta && !bHasDta) return -1;
                if (!aHasDta && bHasDta) return 1;
                
                // Within each group, sort by priority
                const priorityOrder = {'high': 3, 'medium': 2, 'low': 1};
                const aPriority = priorityOrder[a.priority] || 0;
                const bPriority = priorityOrder[b.priority] || 0;
                if (aPriority !== bPriority) return bPriority - aPriority;
                
                // Finally, sort alphabetically by study code
                return a.code.localeCompare(b.code);
            });

            renderStudies();
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalStudies').textContent = allStudies.length;
            document.getElementById('rp1Count').textContent = studyData.rp1.length;
            document.getElementById('rp2Count').textContent = studyData.rp2.length;
            document.getElementById('selectedCount').textContent = selectedStudies.length;
            const notifiedCount = Object.values(notificationsSent).filter(v=>v).length;
            let notifiedStat=document.getElementById('notifiedCount');
            if(!notifiedStat){
                const statBar=document.querySelector('.stats-bar');
                const el=document.createElement('div');
                el.className='stat-card';
                el.innerHTML=`<div class="stat-number" id="notifiedCount">${notifiedCount}</div><div class="stat-label">Notified</div>`;
                statBar.appendChild(el);
            }else{
                notifiedStat.textContent=notifiedCount;
            }
            const dtaCoverage = (allStudies.filter(study => dtaFileMappings[study.code] && !dtaFileMappings[study.code].includes('[filename_TBD]') && !dtaFileMappings[study.code].includes('[multiple_files]')).length / allStudies.length) * 100;
            document.getElementById('dtaCoverage').textContent = `${dtaCoverage.toFixed(2)}%`;
        }

        function renderStudies() {
            const grid = document.getElementById('studiesGrid');
            grid.innerHTML = '';

            filteredStudies.forEach(study => {
                const card = createStudyCard(study);
                grid.appendChild(card);
            });
        }

        function createStudyCard(study) {
            const card = document.createElement('div');
            const notified = notificationsSent[study.code];
            card.className = `study-card ${selectedStudies.includes(study.code) ? 'selected' : ''} ${notified ? 'notified' : ''}`;
            card.onclick = () => toggleStudySelection(study.code);

            const statusClass = getStatusClass(study.status);
            const priorityClass = getPriorityClass(study.priority);

            // Check if DTA file exists and determine status
            const dtaFilePath = dtaFileMappings[study.code];
            let fileStatus = 'missing';
            let linkClass = 'dta-link missing';
            let linkText = 'No DTA File';
            let cardClass = '';
            
            // Get metadata from folder structure (this overrides any hardcoded values)
            let dtaMetadata = { template: 'N/A', recipient: 'N/A', status: 'No DTA' };
            
            if (dtaFilePath) {
                if (dtaFilePath.includes('[filename_TBD]') || dtaFilePath.includes('[multiple_files]')) {
                    fileStatus = 'placeholder';
                    linkClass = 'dta-link missing';
                    linkText = 'File TBD';
                    cardClass = 'no-dta-file';
                    dtaMetadata = { template: 'N/A', recipient: 'N/A', status: 'Pending' };
                } else {
                    fileStatus = 'available';
                    linkClass = 'dta-link';
                    linkText = 'View DTA File';
                    cardClass = 'has-dta-file';
                    // Get actual metadata from folder structure
                    dtaMetadata = getDtaMetadataFromPath(dtaFilePath);
                }
            } else {
                cardClass = 'no-dta-file';
                dtaMetadata = { template: 'N/A', recipient: 'N/A', status: 'Spreadsheet Only' };
            }

            // Add card class for styling
            card.classList.add(cardClass);

            card.innerHTML = `
                <div class="study-header">
                    <div>
                        <div class="study-code">${study.code}</div>
                        <div class="study-status ${statusClass}">${study.status}</div>
                    </div>
                    <div class="study-priority ${priorityClass}">${study.priority}</div>
                </div>
                <div class="study-description">${study.title}</div>
                <div class="dta-metadata-header">
                    <div class="dta-template">Template: <strong>${dtaMetadata.template.toUpperCase()}</strong></div>
                    <div class="dta-recipient">Recipient: <strong>${dtaMetadata.recipient}</strong></div>
                    <div class="dta-status">DTA Status: <strong>${dtaMetadata.status.replace('_', ' ').toUpperCase()}</strong></div>
                </div>
                <div class="study-meta">
                    <div class="meta-item">
                        <span>🌍</span>
                        <span>${study.country}</span>
                    </div>
                    <div class="meta-item">
                        <span>📊</span>
                        <span>${study.sample_size || 'N/A'} participants</span>
                    </div>
                    <div class="meta-item">
                        <span>📁</span>
                        <span>${study.type}</span>
                    </div>
                    <div class="meta-item">
                        <span>📄</span>
                        <span>
                            <span class="file-status-indicator ${fileStatus}"></span>
                            <a href="#" class="${linkClass}" onclick="event.stopPropagation(); ${fileStatus === 'available' ? `openDtaFile('${study.code}')` : `alert('DTA file not available for ${study.code}')`}; return false;">${linkText}</a>
                        </span>
                    </div>
                    <div class="meta-item">
                        <label style="display:flex;align-items:center;cursor:pointer;" onclick="event.stopPropagation();">
                            <input type="checkbox" ${notified ? 'checked' : ''} onchange="toggleNotificationSent('${study.code}', this.checked)"/>
                            <span style="margin-left:6px;">Notified</span>
                        </label>
                    </div>
                </div>
            `;

            return card;
        }

        function getStatusClass(status) {
            if (status.includes('progress')) return 'status-progress';
            if (status.includes('transferred')) return 'status-transferred';
            if (status.includes('ready')) return 'status-ready';
            if (status.includes('DTA')) return 'status-dta';
            if (status.includes('Reactivate')) return 'status-reactivate';
            return 'status-progress';
        }

        function getPriorityClass(priority) {
            switch(priority?.toLowerCase()) {
                case 'high': return 'priority-high';
                case 'medium': return 'priority-medium';
                default: return 'priority-standard';
            }
        }

        function toggleStudySelection(code) {
            if (selectedStudies.includes(code)) {
                selectedStudies = selectedStudies.filter(c => c !== code);
            } else {
                selectedStudies.push(code);
            }
            renderStudies();
            updateStats();
        }

        function generateNotification() {
            if (selectedStudies.length === 0) {
                alert('Please select at least one study to generate a notification.');
                return;
            }

            const selectedStudyData = allStudies.filter(s => selectedStudies.includes(s.code));
            const notificationContent = createNotificationContent(selectedStudyData);
            
            document.getElementById('notificationContent').innerHTML = notificationContent;
            document.getElementById('notificationPreview').classList.add('show');
            
            // Scroll to notification
            document.getElementById('notificationPreview').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function createNotificationContent(studies) {
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let content = '';

            studies.forEach((study, index) => {
                const deadline = new Date();
                deadline.setDate(deadline.getDate() + 5);
                const deadlineStr = deadline.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                content += `
                    <div class="notification-section">
                        <h3>📋 Study Information - ${study.code}</h3>
                        <div class="study-stats">N = ${study.sample_size || 'TBD'}</div>
                        <div class="study-stats">Country: ${study.country}</div>
                        <div class="study-stats">DTA Type: DTA_v2</div>
                        <p><strong>Study Title:</strong> ${study.title}</p>
                    </div>

                    <div class="notification-section">
                        <h3>👥 Contact Information</h3>
                        <p><strong>Primary Contact:</strong> ${study.contact || 'TBD'}<br>
                        <strong>Institution:</strong> ${study.organization || 'TBD'}<br>
                        <strong>Study Code:</strong> ${study.code}</p>
                    </div>

                    <div class="notification-section">
                        <h3>⚖️ Legal Compliance Requirements</h3>
                        <p><strong>Applicable Legislation:</strong> ${getApplicableLegislation(study.country)}</p>
                        <p><strong>Current Arrangement:</strong> ${study.status}</p>
                        <p><strong>Compliance Focus:</strong> Cross-border data transfer regulations</p>
                    </div>

                    <div class="notification-section action-required">
                        <h3>🚨 IMMEDIATE ACTION REQUIRED</h3>
                        <p><strong>Response Deadline:</strong> 5 Business Days (by ${deadlineStr})</p>
                        <p><strong>Required Confirmation:</strong></p>
                        <ul style="padding-left: 20px; margin-top: 10px;">
                            <li>Acknowledgment from ${study.country} and collaborating institutions</li>
                            <li>Agreement to proceed with DTA amendment</li>
                            <li>Confirmation of institutional review board notifications</li>
                        </ul>
                    </div>
                `;

                if (index < studies.length - 1) {
                    content += '<hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">';
                }
            });

            content += `
                <div class="notification-section">
                    <h3>📞 Project Management Contacts</h3>
                    <p><strong>Data Management:</strong> HEAT Center Team<br>
                    <strong>Legal Affairs:</strong> Legal Advisory Board<br>
                    <strong>Technical Support:</strong> Data Analysis Platform Team</p>
                </div>

                <div class="notification-section">
                    <h3>📧 Next Steps</h3>
                    <p>Please review the attached Data Management Plan v2.2 and respond within the specified deadline. For questions or clarifications, contact the HEAT Center project management team.</p>
                    <p><strong>Generated:</strong> ${currentDate}</p>
                </div>
            `;

            return content;
        }

        function getApplicableLegislation(country) {
            const legislation = {
                'Uganda': 'Uganda Data Protection and Privacy Act 2019',
                'Kenya': 'Kenya Data Protection Act 2019',
                'South Africa': 'Protection of Personal Information Act (POPIA) 2020',
                'Ethiopia': 'Ethiopian Data Protection Proclamation',
                'Ghana': 'Ghana Data Protection Act 2012',
                'Botswana': 'Botswana Data Protection Act 2018',
                'Malawi': 'Malawi Data Protection Act'
            };
            return legislation[country] || `${country} Data Protection Legislation`;
        }

        function copyNotification() {
            const content = document.getElementById('notificationContent').innerText;
            navigator.clipboard.writeText(content).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#28a745';
                }, 2000);
            });
        }

        function exportJson() {
            const data = JSON.stringify(allStudies, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'study_data.json';
            a.click();
        }

        function exportCsv() {
            const data = allStudies.map(study => {
                return [
                    study.code,
                    study.title,
                    study.country,
                    study.status,
                    study.type,
                    study.priority,
                    study.sample_size,
                    study.contact
                ].join(',');
            }).join('\n');
            const blob = new Blob([data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'study_data.csv';
            a.click();
        }

        function toggleTheme() {
            document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>